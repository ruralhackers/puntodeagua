// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Necessary for Next auth
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? // @db.Text
  access_token             String? // @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  roles         String[]  @default([]) // e.g., ['ADMIN', 'USER']
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])

  accounts Account[]
  sessions Session[]

  @@index([communityId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Community {
  id             String @id @default(cuid())
  name           String
  waterLimitRule Json   @map("water_limit_rule")

  users         User[]
  zones         CommunityZone[]
  waterDeposits WaterDeposit[]
  analyses      Analysis[]
  incidents     Incident[]
  providers     Provider[]
}

model CommunityZone {
  id   String @id @default(cuid())
  name String

  community   Community @relation(fields: [communityId], references: [id])
  communityId String    @map("community_id")

  notes      String       @default("") @db.Text
  WaterPoint WaterPoint[]
  analyses   Analysis[]
  incidents  Incident[]

  @@index([communityId])
}

model WaterDeposit {
  id       String @id @default(cuid())
  name     String
  location String @default("")

  community   Community @relation(fields: [communityId], references: [id])
  communityId String    @map("community_id")

  notes     String     @default("") @db.Text
  analyses  Analysis[]
  incidents Incident[]

  @@index([communityId])
}

model WaterPoint {
  id       String @id @default(cuid())
  name     String
  location String @default("")

  notes String @default("") @db.Text

  fixedPopulation    Int    @default(0) @map("fixed_population")
  floatingPopulation Int    @default(0) @map("floating_population")
  cadastralReference String @map("cadastral_reference")

  waterDepositIds String[] @default([]) @map("water_deposit_ids")

  communityZone   CommunityZone @relation(fields: [communityZoneId], references: [id])
  communityZoneId String        @map("community_zone_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  waterMeters WaterMeter[]
  incidents   Incident[]

  @@index([communityZoneId])
  @@index([waterDepositIds])
}

model WaterAccount {
  id         String @id @default(cuid())
  name       String
  nationalId String @map("national_id")

  notes String @default("") @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  waterMeters WaterMeter[]
}

model WaterMeter {
  id   String @id @default(cuid())
  name String

  waterAccount   WaterAccount @relation(fields: [waterAccountId], references: [id])
  waterAccountId String       @map("water_account_id")

  waterPoint   WaterPoint @relation(fields: [waterPointId], references: [id], onDelete: Cascade)
  waterPointId String     @map("water_point_id")

  measurementUnit              String
  lastReadingNormalizedValue   Int?      @map("last_reading_normalized_value")
  lastReadingDate              DateTime? @map("last_reading_date")
  lastReadingExcessConsumption Boolean?  @map("last_reading_excess_consumption")
  isActive                     Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  waterMeterReadings WaterMeterReading[]
  waterMeterImage    WaterMeterImage?

  @@index([waterAccountId])
  @@index([waterPointId])
  @@index([isActive])
}

model WaterMeterReading {
  id String @id @default(cuid())

  waterMeter   WaterMeter @relation(fields: [waterMeterId], references: [id], onDelete: Cascade)
  waterMeterId String     @map("water_meter_id")

  reading           Decimal  @db.Decimal(10, 3)
  normalizedReading Int      @map("normalized_reading")
  readingDate       DateTime
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  waterMeterReadingImage WaterMeterReadingImage?

  @@index([waterMeterId])
}

model WaterMeterReadingImage {
  id                  String   @id @default(cuid())
  waterMeterReadingId String   @unique @map("water_meter_reading_id")
  url                 String
  fileName            String   @map("file_name")
  fileSize            Int      @map("file_size")
  mimeType            String   @map("mime_type")
  uploadedAt          DateTime @default(now()) @map("uploaded_at")
  externalKey         String   @map("external_key")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")

  waterMeterReading WaterMeterReading @relation(fields: [waterMeterReadingId], references: [id], onDelete: Cascade)
}

model WaterMeterImage {
  id           String   @id @default(cuid())
  waterMeterId String   @unique @map("water_meter_id")
  url          String
  fileName     String   @map("file_name")
  fileSize     Int      @map("file_size")
  mimeType     String   @map("mime_type")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  externalKey  String   @map("external_key")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  waterMeter WaterMeter @relation(fields: [waterMeterId], references: [id], onDelete: Cascade)
}

model Analysis {
  id String @id @default(cuid())

  community   Community @relation(fields: [communityId], references: [id])
  communityId String    @map("community_id")

  analysisType String
  analyst      String
  analyzedAt   DateTime

  communityZoneId String?        @map("water_zone_id")
  communityZone   CommunityZone? @relation(fields: [communityZoneId], references: [id])
  waterDepositId  String?        @map("water_deposit_id")
  waterDeposit    WaterDeposit?  @relation(fields: [waterDepositId], references: [id])

  ph          String?
  turbidity   String?
  chlorine    String?
  description String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([communityZoneId])
  @@index([waterDepositId])
}

model Incident {
  id String @id @default(cuid())

  community       Community      @relation(fields: [communityId], references: [id])
  communityId     String         @map("community_id")
  communityZoneId String?        @map("water_zone_id")
  communityZone   CommunityZone? @relation(fields: [communityZoneId], references: [id])
  waterDepositId  String?        @map("water_deposit_id")
  waterDeposit    WaterDeposit?  @relation(fields: [waterDepositId], references: [id])
  waterPointId    String?        @map("water_point_id")
  waterPoint      WaterPoint?    @relation(fields: [waterPointId], references: [id])

  title              String
  description        String?
  closingDescription String? @map("closing_description")
  reporterName       String

  status  String
  startAt DateTime
  endAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([communityZoneId])
  @@index([waterDepositId])
  @@index([waterPointId])
}

model Provider {
  id          String  @id @default(cuid())
  companyName String  @map("company_name")
  taxId       String? @map("tax_id")

  // Contact information
  contactPerson  String  @map("contact_person")
  contactPhone   String  @map("contact_phone")
  contactEmail   String? @map("contact_email")
  secondaryPhone String? @map("secondary_phone")
  billingEmail   String? @map("billing_email")

  // Address
  address    String? @db.Text
  city       String?
  postalCode String? @map("postal_code")
  province   String?

  // Provider type (in English)
  providerType       String  @map("provider_type")
  customProviderType String? @map("custom_provider_type")

  // Operational details
  isActive           Boolean @default(true) @map("is_active")
  notes              String  @default("") @db.Text
  businessHours      String? @map("business_hours")
  emergencyAvailable Boolean @default(false) @map("emergency_available")
  emergencyPhone     String? @map("emergency_phone")

  // Administrative/Financial
  bankAccount  String? @map("bank_account")
  paymentTerms String? @map("payment_terms")
  website      String?

  // Relations
  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([communityId])
  @@index([providerType])
  @@index([isActive])
}
